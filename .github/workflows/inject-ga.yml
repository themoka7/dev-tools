name: Inject Google Analytics into HTML

on:
  push:
    branches:
      - main

jobs:
  inject-ga:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Inject GA after title tag
        run: |
          cat <<'EOF' > /tmp/ga.html
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QETV2ZT0NN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QETV2ZT0NN');
</script>
EOF

          find . -name "*.html" -type f | while read file; do
            if grep -q "<title>Online Tools Cafe - Free Developer Tools</title>" "$file"; then
              if ! grep -q "G-QETV2ZT0NN" "$file"; then
                sed -i "/<title>Online Tools Cafe - Free Developer Tools<\/title>/r /tmp/ga.html" "$file"
              fi
            fi
          done

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "chore: inject Google Analytics into HTML" || echo "No changes to commit"

      - name: Push changes
        run: git push
